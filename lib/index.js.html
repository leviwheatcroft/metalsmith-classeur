<!DOCTYPE html>
<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../";
    var thisFile = "lib/index.js";
    var defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h3">
        <a href="#default">default</a>
      </div>

      <div class="heading h2">
        <a href="#scrape">scrape</a>
      </div>

      <div class="heading h3">
        <a href="#streamfiles">streamFiles</a>
      </div>

      <div class="heading h2">
        <a href="#processfiles">processFiles</a>
      </div>

      <div class="heading h2">
        <a href="#_write">_write</a>
      </div>

      <div class="heading h3">
        <a href="#downloadfile">downloadFile</a>
      </div>

      <div class="heading h2">
        <a href="#coercefile">coerceFile</a>
      </div>

      <div class="heading h3">
        <a href="#storefile">storeFile</a>
      </div>

      <div class="heading h3">
        <a href="#_getfiles">_getFiles</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>index.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">import</span> debug <span class="hljs-keyword">from</span> <span class="hljs-string">'debug'</span>
<span class="hljs-keyword">import</span> vow <span class="hljs-keyword">from</span> <span class="hljs-string">'vow'</span>
<span class="hljs-keyword">import</span> flashheart <span class="hljs-keyword">from</span> <span class="hljs-string">'flashheart'</span>
<span class="hljs-keyword">import</span> util <span class="hljs-keyword">from</span> <span class="hljs-string">'util'</span>
<span class="hljs-keyword">import</span> {
  Readable,
  Writable
} <span class="hljs-keyword">from</span> <span class="hljs-string">'stream'</span>
<span class="hljs-keyword">import</span> {
  join
} <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>
<span class="hljs-keyword">import</span> {
  FileCache,
  ValueCache,
  init <span class="hljs-keyword">as</span> initCache,
  save <span class="hljs-keyword">as</span> saveCache
} <span class="hljs-keyword">from</span> <span class="hljs-string">'metalsmith-cache'</span>

<span class="hljs-keyword">let</span> fileCache = <span class="hljs-literal">false</span>
<span class="hljs-keyword">let</span> valueCache = <span class="hljs-literal">false</span>

initCache().then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  fileCache = <span class="hljs-keyword">new</span> FileCache(<span class="hljs-string">'classeur'</span>)
  valueCache = <span class="hljs-keyword">new</span> ValueCache(<span class="hljs-string">'classeur-params'</span>)
})

<span class="hljs-keyword">const</span> dbg = debug(<span class="hljs-string">'metalsmith-classeur'</span>)
<span class="hljs-keyword">const</span> host = <span class="hljs-string">'https://app.classeur.io'</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="default">
  <h3>
    <a href="#default" name="default" class="pilcrow"></a>
default
  </h3>
</div>
</div>
<div class="body">
<p>see README.md re: auth properties</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">options</span>
<span class="dox_type">Object</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">options.srcId</span>
<span class="dox_type">String</span>
<span>classeur folder id
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">options.destPath</span>
<span class="dox_type">String</span>
<span>path under which to place files for metalsmith
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">options.userId</span>
<span class="dox_type">Object</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">options.apiKey</span>
<span class="dox_type">String</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">plugin</span> (<span class="hljs-params">options</span>) </span>{
  <span class="hljs-keyword">if</span> (!options) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'no options passed'</span>)
  <span class="hljs-keyword">if</span> (!options.srcId) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'required: options.src'</span>)
  <span class="hljs-keyword">if</span> (!options.destPath) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'required: options.dest'</span>)
  <span class="hljs-keyword">if</span> (!options.userId) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'required: options.userId'</span>)
  <span class="hljs-keyword">if</span> (!options.apiKey) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'required: options.apiKey'</span>)
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>if (options.cache !== undefined) cache = options.cache</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (options.invalidateCache) {
    initCache().then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      dbg(<span class="hljs-string">'invalidating cache'</span>)
      fileCache.collection.clear()
      valueCache.collection.clear()
    })
  }
  <span class="hljs-keyword">const</span> folder = <span class="hljs-keyword">new</span> Folder(options)
  <span class="hljs-keyword">return</span> folder.classeur.bind(folder)
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Folder</span> </span>{
  <span class="hljs-keyword">constructor</span> (options) {
    <span class="hljs-built_in">Object</span>.assign(<span class="hljs-keyword">this</span>, options)
    <span class="hljs-keyword">this</span>.initClient(options.userId, options.apiKey)
  }
  initClient (username, password) {
    <span class="hljs-keyword">this</span>.client = flashheart.createClient({
      <span class="hljs-attr">name</span>: <span class="hljs-built_in">module</span>.exports.name,
      <span class="hljs-attr">userAgent</span>: util.format(
        <span class="hljs-string">'%s/%s (%s)'</span>,
        <span class="hljs-built_in">module</span>.exports.name,
        <span class="hljs-built_in">module</span>.exports.version,
        flashheart.createClient().userAgent
      ),
      <span class="hljs-attr">defaults</span>: {
        <span class="hljs-attr">auth</span>: {username, password}
      }
    })
  }
  classeur (files, metalsmith) {
    <span class="hljs-keyword">this</span>.files = files
    <span class="hljs-keyword">this</span>.metalsmith = metalsmith
    <span class="hljs-keyword">return</span> vow.resolve()
    .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> initCache())
    .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-keyword">this</span>.scrape())
    .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-keyword">this</span>.mergeStore())
    .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> valueCache.store(<span class="hljs-keyword">this</span>.src, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()))
    .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> saveCache())
    .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> vow.resolve(<span class="hljs-keyword">this</span>.files))
    .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (err === <span class="hljs-string">'skip'</span>) <span class="hljs-keyword">return</span> dbg(<span class="hljs-string">'skipped scrape'</span>)
      dbg(err)
    })
  }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="scrape">
  <h2>
    <a href="#scrape" name="scrape" class="pilcrow"></a>
scrape
  </h2>
</div>
<p>pipes fileIds from readable to writable managing workers</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">srcId</span>
<span class="dox_type">string</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  scrape () {
    dbg(<span class="hljs-string">'scrape'</span>, <span class="hljs-keyword">this</span>.srcId)
    <span class="hljs-keyword">const</span> defer = vow.defer()
    <span class="hljs-keyword">const</span> stream = <span class="hljs-keyword">this</span>.streamFiles()
    stream.on(<span class="hljs-string">'error'</span>, defer.reject.bind(defer))
    <span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">this</span>.processFiles()
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>can't use 'finish' event bacause async write fn</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    worker.on(<span class="hljs-string">'done'</span>, defer.resolve.bind(defer))
    worker.on(<span class="hljs-string">'error'</span>, defer.reject.bind(defer))

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>now kiss!</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    stream.pipe(worker)

    <span class="hljs-keyword">return</span> defer.promise()
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="streamfiles">
  <h3>
    <a href="#streamfiles" name="streamfiles" class="pilcrow"></a>
streamFiles
  </h3>
</div>
<p>creates a readable stream to read file ids from api as required
requests 20 files at a time
can implement an <code>updatedAt</code> filter here</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">parent</span>
<span class="dox_type">String</span>
<span>id of parent folder
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  streamFiles () {
    <span class="hljs-keyword">const</span> folder = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.assign(
      <span class="hljs-keyword">new</span> Readable({
        <span class="hljs-attr">objectMode</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">highWaterMark</span>: <span class="hljs-number">60</span>
      }),
      {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>buffer docs ready to be pushed to outbound stream buffer</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        toPush: [],
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>flag to ensure we don't request again if already awaiting request
and <code>_read</code> is called</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        requested: <span class="hljs-literal">false</span>,
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>flag for whether EOF has been reached</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        exhausted: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">_read</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_read</span> (<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">this</span>._next()
        },
        <span class="hljs-attr">_next</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_next</span> (<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>if our toPush is empty, request more</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.toPush.length) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._request()
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>push oldest item</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          <span class="hljs-keyword">const</span> oldest = <span class="hljs-keyword">this</span>.toPush.shift()
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.push(oldest)) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>then go again if this.push returned truthy</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">return</span> process.nextTick(<span class="hljs-keyword">this</span>._next.bind(<span class="hljs-keyword">this</span>))
          }
        },
        <span class="hljs-attr">_request</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_request</span> (<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>block additional requests</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.requested) <span class="hljs-keyword">return</span>
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.exhausted) <span class="hljs-keyword">return</span>
          <span class="hljs-keyword">this</span>.requested = <span class="hljs-literal">true</span>
          <span class="hljs-keyword">const</span> request = {}
          request.sort = <span class="hljs-string">'updated'</span>
          request.direction = <span class="hljs-string">'desc'</span>
          request.range = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">this</span>.count}</span>-<span class="hljs-subst">${<span class="hljs-keyword">this</span>.count + <span class="hljs-number">19</span>}</span>`</span>
          <span class="hljs-keyword">const</span> url = <span class="hljs-string">`<span class="hljs-subst">${host}</span>/api/v2/folders/<span class="hljs-subst">${folder.srcId}</span>/files`</span>
          folder.client.get(url, {<span class="hljs-attr">qs</span>: request}, (err, body) =&gt; {
            <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(err)
            <span class="hljs-keyword">this</span>.count += body.length
            body.forEach(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> {
              <span class="hljs-keyword">this</span>.toPush.push(file)
            })
            <span class="hljs-keyword">if</span> (body.length &lt; <span class="hljs-number">20</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>end of stream</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">              dbg(<span class="hljs-string">`scraped <span class="hljs-subst">${<span class="hljs-keyword">this</span>.count}</span> files`</span>)
              <span class="hljs-keyword">this</span>.toPush.push(<span class="hljs-literal">null</span>)
              <span class="hljs-keyword">this</span>.exhausted = <span class="hljs-literal">true</span>
            } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>not end of stream</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            }
            <span class="hljs-keyword">this</span>.requested = <span class="hljs-literal">false</span>
            <span class="hljs-keyword">this</span>._next()
          })
        }
      }
    )
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="processfiles">
  <h2>
    <a href="#processfiles" name="processfiles" class="pilcrow"></a>
processFiles
  </h2>
</div>
<p>returns a writable stream which can spawn multiple workers to process
fileIds</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  processFiles () {
    <span class="hljs-keyword">const</span> folder = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">const</span> writable = <span class="hljs-built_in">Object</span>.assign(
      <span class="hljs-keyword">new</span> Writable({
        <span class="hljs-attr">objectMode</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">highWaterMark</span>: <span class="hljs-number">60</span>
      }),
      {
        <span class="hljs-attr">concurrency</span>: <span class="hljs-number">5</span>, <span class="hljs-comment">// configurable here</span>
        workers: <span class="hljs-number">0</span>, <span class="hljs-comment">// don't change this</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="_write">
  <h2>
    <a href="#_write" name="_write" class="pilcrow"></a>
_write
  </h2>
</div>
<p>this is where the parallel stream magic happens..
each time <code>_write</code> is called, we either call <code>next</code> immediately (if
we haven't yet reached concurrency limit) or we call <code>next</code> once the
worker has finished.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">file</span>
<span class="dox_type">Object</span>
<span>pushed from streamFiles
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">encoding</span>
<span class="dox_type">String</span>
<span>ignored
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">next</span>
<span class="dox_type">Function</span>
<span>call when ready for subsequent worker to start
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        _write: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_write</span> (<span class="hljs-params">file, encoding, next</span>) </span>{
          <span class="hljs-keyword">this</span>.workers++
          vow.resolve(file)
          .then(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> folder.downloadFile(file))
          .then(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> folder.storeFile(file))
          .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            dbg(err)
            dbg(<span class="hljs-string">'worker errored'</span>)
          })
          .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
            <span class="hljs-keyword">this</span>.workers--
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>emit 'done' after all async workers have completed</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isFinished &amp;&amp; <span class="hljs-keyword">this</span>.workers === <span class="hljs-number">0</span>) {
              <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'done'</span>)
            }
            next()
          })

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>if not at concurrency limit, call next immediately (don't wait for
worker to finish)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.workers &lt; <span class="hljs-keyword">this</span>.concurrency) {
            next()
            next = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {}
          }
        }
      }
    )
    writable.on(<span class="hljs-string">'finish'</span>, () =&gt; {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>set flag so we can emit 'done' event after async write</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      writable.isFinished = <span class="hljs-literal">true</span>
    })
    <span class="hljs-keyword">return</span> writable
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="downloadfile">
  <h3>
    <a href="#downloadfile" name="downloadfile" class="pilcrow"></a>
downloadFile
  </h3>
</div>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">file</span>
<span class="dox_type">Object</span>
<span>as streadmed from _streamFiles
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  downloadFile (file) {
    dbg(<span class="hljs-string">`downloading "<span class="hljs-subst">${file.name}</span>"`</span>)

    <span class="hljs-keyword">const</span> defer = vow.defer()
    <span class="hljs-keyword">const</span> url = <span class="hljs-string">`<span class="hljs-subst">${host}</span>/api/v2/files/<span class="hljs-subst">${file.id}</span>/contentRevs/last`</span>
    <span class="hljs-keyword">this</span>.client.get(url, (err, body) =&gt; {
      <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> defer.reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(err))
      file = <span class="hljs-built_in">Object</span>.assign(file, body)
      file = <span class="hljs-keyword">this</span>.coerceFile(file)
      defer.resolve(file)
    })
    <span class="hljs-keyword">return</span> defer.promise()
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="coercefile">
  <h2>
    <a href="#coercefile" name="coercefile" class="pilcrow"></a>
coerceFile
  </h2>
</div>
<p>make the file a little more metalsmith</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  coerceFile (file) {
    file.contents = Buffer.from(file.text)
    <span class="hljs-keyword">delete</span> file.text
    file.modifiedDate = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(file.updated)
    <span class="hljs-keyword">delete</span> file.updated
    <span class="hljs-keyword">return</span> file
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="storefile">
  <h3>
    <a href="#storefile" name="storefile" class="pilcrow"></a>
storeFile
  </h3>
</div>
</div>
<div class="body">
<p>store file in persist cache with drive id as key</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">file</span>
<span class="dox_type">Object</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  storeFile (file) {
    fileCache.store(join(<span class="hljs-keyword">this</span>.destPath, file.name), file)
    <span class="hljs-keyword">return</span> file
  }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="_getfiles">
  <h3>
    <a href="#_getfiles" name="_getfiles" class="pilcrow"></a>
_getFiles
  </h3>
</div>
</div>
<div class="body">
<p>this gets files from local persistent store</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">dest</span>
<span class="dox_type">String</span>
<span>path under which to store files
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  mergeStore () {
    <span class="hljs-keyword">const</span> files = fileCache.all()
    <span class="hljs-keyword">const</span> count = <span class="hljs-built_in">Object</span>.keys(files).length
    dbg(<span class="hljs-string">`merging <span class="hljs-subst">${count}</span> tracked files from <span class="hljs-subst">${<span class="hljs-keyword">this</span>.srcId}</span>`</span>)
    <span class="hljs-built_in">Object</span>.assign(<span class="hljs-keyword">this</span>.files, files)
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> plugin
<span class="hljs-keyword">export</span> {
  plugin
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
